<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Canvas</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
    <!-- CodeMirror Theme (Dracula theme - modern dark) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/dracula.min.css">
    <!-- CodeMirror Addons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/display/fullscreen.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/search/matchesonscrollbar.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/show-hint.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/lint/lint.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/dialog/dialog.min.css">
    <!-- FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* Inter font for a modern, professional look */
        @import url('https://rsms.me/inter/inter.css');
        html { font-family: 'Inter', sans-serif; }
        @supports (font-variation-settings: normal) {
            html { font-family: 'Inter var', sans-serif; }
        }

        /* Define CSS variable for top action bar height */
        :root {
            --top-action-bar-height: 45px; /* Approximate height of the top bar */
        }

        /* Base styles for body - Darker theme */
        body {
            background-color: #1e1e1e; /* VSCode-like dark background */
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh; /* Ensure body takes full viewport height */
            padding: 0; /* Remove body padding */
            box-sizing: border-box;
            color: #d4d4d4; /* Default text color for dark theme */
            overflow: hidden; /* Prevent body scrollbar */
        }

        /* Top Action Bar - Mimics VSCode's top menus/toolbar */
        .top-action-bar {
            width: 100%;
            height: var(--top-action-bar-height); /* Fixed height */
            background-color: #252526; /* Darker than editor, lighter than body */
            border-bottom: 1px solid #3c3c3c;
            display: flex;
            justify-content: flex-end; /* Align items to the right by default */
            align-items: center;
            padding: 0 16px; /* Compact padding, height is now fixed */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            z-index: 10; /* Ensure it stays on top */
            position: relative; /* For dropdown positioning */
            flex-shrink: 0; /* Prevent it from shrinking */
        }

        .action-button-icon {
            background-color: transparent; /* No background by default */
            border: none;
            color: #d4d4d4; /* Icon color */
            font-size: 1.25rem; /* Larger icon size */
            padding: 8px; /* Touch target padding */
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            display: flex; /* For proper icon alignment */
            align-items: center;
            justify-content: center;
            line-height: 1; /* Remove extra line height */
        }

        .action-button-icon:hover {
            background-color: #3c3c3c; /* Subtle hover background */
            color: #ffffff; /* Brighter icon on hover */
        }
        .action-button-icon:active {
            background-color: #4a4a4a;
        }

        .container {
            width: 100%; /* Take full width */
            /* Calculate height based on viewport height minus top bar height */
            height: calc(100vh - var(--top-action-bar-height));
            display: grid;
            grid-template-columns: 1fr;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            border-radius: 0;
            overflow: hidden; /* Crucial: Container handles its own overflow by letting grid items fill it */
            background-color: #252526;
            border: none;
        }

        @media (min-width: 768px) {
            .container {
                grid-template-columns: 1fr 1fr;
                grid-template-rows: 1fr;
            }
        }

        .editor-panel, .output-panel {
            display: flex;
            flex-direction: column;
            background-color: #1e1e1e;
            border-radius: 0;
            /* No overflow here, as CodeMirror and #output handle their own scrolling */
            height: 100%; /* Fill parent container's height */
        }

        @media (min-width: 768px) {
            .editor-panel {
                border-right: 1px solid #3c3c3c;
            }
        }
        @media (max-width: 767px) {
             .editor-panel {
                border-bottom: 1px solid #3c3c3c;
            }
        }

        /* CodeMirror editor styling to resemble VSCode */
        .CodeMirror {
            border: none;
            border-radius: 0;
            font-family: 'Fira Code', 'Cascadia Code', 'Consolas', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            height: 100%; /* CodeMirror itself fills its panel */
            flex-grow: 1;
            overflow: hidden; /* CodeMirror's internal scroll handles overflow */
            background-color: #1e1e1e !important;
            padding-bottom: 0;
        }
        .CodeMirror-gutters {
            background-color: #252526 !important;
            border-right: 1px solid #3c3c3c !important;
        }
        .CodeMirror-linenumber {
            color: #858585 !important;
        }
        .CodeMirror-cursor {
            border-left: 1.5px solid #ffffff !important;
        }
        .CodeMirror-selected {
            background-color: #364966 !important;
        }
        .CodeMirror-focused .CodeMirror-selected {
            background-color: #364966 !important;
        }
        .CodeMirror-activeline-background {
            background: #323232 !important;
        }
        /* Custom Scrollbar for CodeMirror (Webkit only for simplicity) */
        .CodeMirror-scroll::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .CodeMirror-scroll::-webkit-scrollbar-track {
            background: #252526;
            border-radius: 4px;
        }
        .CodeMirror-scroll::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }
        .CodeMirror-scroll::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        /* Terminal/Output area */
        #output {
            background-color: #1a1a1a;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 0;
            overflow-y: auto; /* This element will scroll its content */
            flex-grow: 1;
            font-family: 'Fira Code', 'Cascadia Code', 'Consolas', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
            height: 100%; /* Fill panel's height */
        }

        /* Control Panel for Library - Initially hidden */
        .library-control-panel {
            position: absolute;
            top: var(--top-action-bar-height); /* Position right below the top action bar */
            right: 0;
            background-color: #2d2d2d;
            border: 1px solid #3c3c3c;
            border-top: none;
            border-radius: 0 0 8px 8px;
            padding: 15px;
            width: 300px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            display: none;
            flex-direction: column;
            gap: 10px;
            z-index: 20;
        }
        .library-control-panel.active {
            display: flex;
        }


        /* Library input styling */
        #library-url {
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            padding: 7px 10px;
            border-radius: 4px;
            border: 1px solid #3c3c3c;
            background-color: #333333;
            color: #d4d4d4;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.2);
            width: 100%;
        }
        #library-url::placeholder {
            color: #858585;
        }
        #library-url:focus {
            border-color: #007acc;
            box-shadow: 0 0 0 1px #007acc;
        }

        /* Load Library Button */
        #load-library-button {
            background-color: #6a0dad;
            color: white;
            font-weight: 500;
            padding: 8px 15px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background-color 0.2s ease, transform 0.1s ease;
            border: none;
            width: 100%;
        }
        #load-library-button:hover {
            background-color: #5a0ca0;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        #load-library-button:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        /* Status messages */
        #library-status {
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-top: 5px;
            border: 1px solid transparent;
            color: #d4d4d4;
            text-align: center;
        }
        .text-red-600 { background-color: #4a1e1e; border-color: #8b0000; color: #ff8888; }
        .text-yellow-600 { background-color: #4a4a1e; border-color: #8b8b00; color: #ffff88; }
        .text-blue-600 { background-color: #1a2a4a; border-color: #004080; color: #aaddff; }
        .text-green-600 { background-color: #1e4a1e; border-color: #008000; color: #aaffaa; }

    </style>
</head>
<body class="bg-gray-900">
    <!-- Top Action Bar -->
    <div class="top-action-bar">
        <!-- Run Code Button (Play Icon) -->
        <button id="run-button" class="action-button-icon" title="Run Code (F5)">
            <i class="fas fa-play"></i>
        </button>
        <!-- Tools/Library Button (Cog Icon) -->
        <button id="tools-button" class="action-button-icon ml-2" title="Tools & Libraries">
            <i class="fas fa-cog"></i>
        </button>

        <!-- Library Control Panel (Initially Hidden) -->
        <div id="library-control-panel" class="library-control-panel">
            <h3 class="text-white text-md font-semibold mb-2">Load External Library</h3>
            <input type="text" id="library-url" placeholder="Paste library URL (e.g., d3.min.js)">
            <button id="load-library-button">Load Library</button>
            <div id="library-status"></div>
        </div>
    </div>

    <div class="container">
        <!-- Editor Panel -->
        <div class="editor-panel">
            <textarea id="code-editor"></textarea>
        </div>

        <!-- Output Panel -->
        <div class="output-panel">
            <pre id="output"></pre>
        </div>
    </div>

    <!-- CodeMirror JS Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js"></script>
    <!-- CodeMirror Addons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/display/fullscreen.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/search/search.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/search/searchcursor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/search/matchesonscrollbar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/search/jump-to-line.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/dialog/dialog.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/javascript-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/lint/lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/lint/javascript-lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/keymap/sublime.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jshint/2.13.5/jshint.min.js"></script> <!-- Required for javascript-lint -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/fold/brace-fold.min.js"></script>


    <script>
        // Get references to DOM elements
        const codeEditorElement = document.getElementById('code-editor');
        const runButton = document.getElementById('run-button');
        const outputConsole = document.getElementById('output');
        const libraryUrlInput = document.getElementById('library-url');
        const loadLibraryButton = document.getElementById('load-library-button');
        const libraryStatus = document.getElementById('library-status');
        const toolsButton = document.getElementById('tools-button');
        const libraryControlPanel = document.getElementById('library-control-panel');

        // Initialize CodeMirror editor
        const editor = CodeMirror.fromTextArea(codeEditorElement, {
            mode: 'javascript',
            theme: 'dracula',
            lineNumbers: true,
            indentUnit: 2,
            tabSize: 2,
            lineWrapping: true,
            autoCloseBrackets: true,
            matchBrackets: true,
            extraKeys: {
                "F11": function(cm) {
                    cm.setOption("fullScreen", !cm.getOption("fullScreen"));
                },
                "Esc": function(cm) {
                    if (cm.getOption("fullScreen")) cm.setOption("fullScreen", false);
                },
                "Ctrl-Space": "autocomplete",
                "Ctrl-Q": function(cm){
                    cm.foldCode(cm.getCursor());
                },
                "F5": function(cm) { // Map F5 to run code
                    runButton.click();
                }
            },
            keyMap: "sublime",
            foldGutter: true,
            gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter", "CodeMirror-lint-markers"],
            lint: true,
            hintOptions: { hint: CodeMirror.hint.javascript, completeSingle: false },
            value: `// Welcome to the Code Canvas!
// This environment offers a VSCode-like experience directly in your browser.

// Editor Features:
// - VSCode-like Dark Theme (Dracula)
// - Line Numbers & Syntax Highlighting
// - Bracket Matching & Auto-closing
// - Autocompletion (Ctrl+Space or auto-trigger after typing a period for objects)
// - Linting (errors/warnings highlighted in the gutter)
// - Fullscreen Mode (F11)
// - Search & Replace (Ctrl+F)
// - Sublime Text Keymap (e.g., Ctrl+D to select next occurrence)
// - Run Code with F5 or the Play icon above

function greet(name) {
  return "Hello, " + name + "!";
}

console.log(greet('Engineers'));

// Try loading a library via the 'Tools' (cog icon) in the top-right.
// Example: Lodash (https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js)
// Then use it: console.log('Lodash is array:', _.isArray([]));

// Example of an intentional linting warning:
var x = 10;
`
        });

        // --- Code Execution Logic ---
        runButton.addEventListener('click', () => {
            const codeToExecute = editor.getValue();
            outputConsole.textContent = ''; // Clear previous output

            const originalConsoleLog = console.log;
            const originalConsoleError = console.error;

            console.log = (...args) => {
                outputConsole.textContent += args.map(arg => {
                    if (typeof arg === 'object' && arg !== null) {
                        try {
                            return JSON.stringify(arg, null, 2);
                        } catch (e) {
                            return String(arg);
                        }
                    }
                    return String(arg);
                }).join(' ') + '\n';
                originalConsoleLog(...args);
            };
            console.error = (...args) => {
                outputConsole.textContent += 'ERROR: ' + args.map(arg => {
                    if (typeof arg === 'object' && arg !== null) {
                        try {
                            return JSON.stringify(arg, null, 2);
                        } catch (e) {
                            return String(arg);
                        }
                    }
                    return String(arg);
                }).join(' ') + '\n';
                originalConsoleError(...args);
            };

            try {
                const executableFunction = new Function(codeToExecute);
                executableFunction();
            } catch (error) {
                console.error('Execution Error:', error);
            } finally {
                setTimeout(() => {
                    console.log = originalConsoleLog;
                    console.error = originalConsoleError;
                }, 100);
            }
        });

        // --- Library Loading Logic ---
        loadLibraryButton.addEventListener('click', () => {
            const libraryUrl = libraryUrlInput.value.trim();
            if (!libraryUrl) {
                libraryStatus.textContent = 'Please enter a library URL.';
                libraryStatus.className = 'mt-3 text-sm text-red-600';
                return;
            }

            const existingScripts = document.querySelectorAll(`script[src="${libraryUrl}"]`);
            if (existingScripts.length > 0) {
                libraryStatus.textContent = 'Library already loaded.';
                libraryStatus.className = 'mt-3 text-sm text-yellow-600';
                return;
            }

            libraryStatus.textContent = 'Loading library...';
            libraryStatus.className = 'mt-3 text-sm text-blue-600';

            const script = document.createElement('script');
            script.src = libraryUrl;
            script.async = true;

            script.onload = () => {
                libraryStatus.textContent = `Library "${libraryUrl.split('/').pop()}" loaded successfully!`;
                libraryStatus.className = 'mt-3 text-sm text-green-600';
                libraryUrlInput.value = '';
            };

            script.onerror = (e) => {
                libraryStatus.textContent = `Failed to load library from "${libraryUrl}". Check the URL.`;
                libraryStatus.className = 'mt-3 text-sm text-red-600';
                console.error('Failed to load library:', libraryUrl, e);
            };

            document.head.appendChild(script);
        });

        // --- UI Interaction Logic ---
        toolsButton.addEventListener('click', (event) => {
            libraryControlPanel.classList.toggle('active');
            event.stopPropagation(); // Prevent click from propagating to document
        });

        // Close the library panel if clicking outside it
        document.addEventListener('click', (event) => {
            if (!libraryControlPanel.contains(event.target) && libraryControlPanel.classList.contains('active')) {
                libraryControlPanel.classList.remove('active');
            }
        });

        // CodeMirror auto-completion trigger
        editor.on("inputRead", function(cm, change) {
            if (change.text[0] === "." || (change.origin === "+input" && /[\w$]$/.test(change.text[0]))) {
                CodeMirror.commands.autocomplete(cm, null, { completeSingle: false });
            }
        });

        // Initial setup for CodeMirror to take full height
        editor.setSize(null, '100%');
    </script>
</body>
</html>
