<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Canvas - Professional Editor</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
    <!-- CodeMirror Theme (Dracula theme - modern dark) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/dracula.min.css">
    <!-- CodeMirror Addons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/display/fullscreen.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/search/matchesonscrollbar.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/show-hint.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/lint/lint.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/dialog/dialog.min.css">


    <style>
        /* Inter font for a modern, professional look */
        @import url('https://rsms.me/inter/inter.css');
        html { font-family: 'Inter', sans-serif; }
        @supports (font-variation-settings: normal) {
            html { font-family: 'Inter var', sans-serif; }
        }

        /* Base styles for body - Darker theme */
        body {
            background-color: #1e1e1e; /* VSCode-like dark background */
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            padding: 24px;
            box-sizing: border-box;
            color: #d4d4d4; /* Default text color for dark theme */
            overflow: hidden; /* Prevent body scrollbar */
        }

        /* Main application header - Simplified */
        .app-header {
            width: 100%; /* Take full width within parent */
            max-width: 1200px;
            text-align: center;
            margin-bottom: 20px; /* Reduced margin */
            padding-bottom: 10px;
            /* border-bottom: 1px solid #333333; */ /* Removed explicit border to integrate better */
        }
        .app-header h1 {
            color: #ffffff;
            font-size: 2.5rem; /* Slightly smaller header */
            font-weight: 700; /* Bold */
        }
        .app-header p {
            color: #a0a0a0;
            font-size: 1rem; /* Smaller tagline */
        }

        .container {
            width: 95%;
            max-width: 1200px;
            height: calc(100vh - 120px); /* Calculate height to fit viewport, leaving space for header/padding */
            display: grid;
            grid-template-columns: 1fr;
            /* Removed gap, using negative margins/borders for seamless look */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            border-radius: 8px; /* Slightly less rounded for a tighter fit */
            overflow: hidden; /* Crucial for containing inner elements with borders */
            background-color: #252526; /* VSCode-like panel background */
            border: 1px solid #3c3c3c;
            position: relative; /* For z-index of panels if needed */
        }

        @media (min-width: 768px) {
            .container {
                grid-template-columns: 1fr 1fr;
                grid-template-rows: 1fr; /* Ensure rows are equal height */
            }
        }

        .editor-panel, .output-panel {
            display: flex;
            flex-direction: column;
            background-color: #1e1e1e; /* VSCode editor background */
            /* No direct padding or borders here, let inner elements define it */
            border-radius: 0; /* No rounding, corners are on the container */
            overflow: hidden;
            height: 100%; /* Occupy full height of parent */
        }

        /* Specific border for the separator in desktop view */
        @media (min-width: 768px) {
            .editor-panel {
                border-right: 1px solid #3c3c3c; /* Separator between editor and output */
            }
        }
        @media (max-width: 767px) {
             .editor-panel {
                border-bottom: 1px solid #3c3c3c; /* Separator between editor and output on mobile */
            }
        }


        /* CodeMirror editor styling to resemble VSCode */
        .CodeMirror {
            border: none; /* No border for the editor itself */
            border-radius: 0; /* No rounding, controlled by panel/container */
            font-family: 'Fira Code', 'Cascadia Code', 'Consolas', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            height: 100%; /* Fill available space within panel */
            flex-grow: 1; /* Allow CodeMirror to grow */
            overflow: hidden;
            background-color: #1e1e1e !important; /* Force Dracula theme background */
            padding-bottom: 0; /* Ensure no extra padding at bottom of editor area */
        }
        .CodeMirror-gutters {
            background-color: #252526 !important; /* VSCode gutter background */
            border-right: 1px solid #3c3c3c !important; /* Gutter separator */
        }
        .CodeMirror-linenumber {
            color: #858585 !important; /* Line number color */
        }
        .CodeMirror-cursor {
            border-left: 1.5px solid #ffffff !important; /* White block cursor like VSCode */
        }
        .CodeMirror-selected {
            background-color: #364966 !important; /* VSCode selection color */
        }
        .CodeMirror-focused .CodeMirror-selected {
            background-color: #364966 !important; /* Consistent selection */
        }
        .CodeMirror-activeline-background {
            background: #323232 !important; /* Active line background */
        }
        /* Custom Scrollbar for CodeMirror (Webkit only for simplicity) */
        .CodeMirror-scroll::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .CodeMirror-scroll::-webkit-scrollbar-track {
            background: #252526;
            border-radius: 4px;
        }
        .CodeMirror-scroll::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }
        .CodeMirror-scroll::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        /* Terminal/Output area */
        #output {
            background-color: #1a1a1a; /* Even darker for terminal-like output */
            color: #d4d4d4;
            padding: 15px; /* Slightly less padding to feel more like a terminal */
            border-radius: 0; /* No rounding */
            overflow-y: auto;
            flex-grow: 1;
            font-family: 'Fira Code', 'Cascadia Code', 'Consolas', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
            height: 100%; /* Fill available space within panel */
        }

        /* Control Panel at the bottom of the editor section */
        .control-panel {
            background-color: #252526; /* Match container/gutter background */
            padding: 12px 20px; /* Padding for the controls */
            border-top: 1px solid #3c3c3c; /* Separator from editor */
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex-shrink: 0; /* Prevent panel from shrinking */
        }

        /* Library input styling refinement */
        #library-url {
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            padding: 8px 10px; /* Smaller padding for a more compact look */
            border-radius: 4px; /* More subtle rounding */
            border: 1px solid #3c3c3c;
            background-color: #333333;
            color: #d4d4d4;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        #library-url::placeholder {
            color: #858585;
        }
        #library-url:focus {
            border-color: #007acc;
            box-shadow: 0 0 0 1px #007acc;
        }

        /* Button styling - consistent with VSCode actions */
        .action-button {
            background-color: #007acc;
            color: white;
            font-weight: 600;
            padding: 8px 16px; /* Smaller buttons */
            border-radius: 4px; /* More subtle rounding */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background-color 0.2s ease, transform 0.1s ease;
            border: none;
            width: 100%; /* Full width within control panel */
        }

        .action-button:hover {
            background-color: #0060a0;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .action-button:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        /* Library button specific styling */
        .library-button {
            background-color: #6a0dad;
        }
        .library-button:hover {
            background-color: #5a0ca0;
        }

        /* Status messages - tightly integrated */
        #library-status {
            padding: 6px 10px; /* Reduced padding */
            border-radius: 4px;
            font-size: 0.75rem; /* Even smaller font */
            margin-top: 5px; /* Reduced margin */
            border: 1px solid transparent;
            color: #d4d4d4;
            text-align: center; /* Center align status text */
        }
        .text-red-600 { background-color: #4a1e1e; border-color: #8b0000; color: #ff8888; }
        .text-yellow-600 { background-color: #4a4a1e; border-color: #8b8b00; color: #ffff88; }
        .text-blue-600 { background-color: #1a2a4a; border-color: #004080; color: #aaddff; }
        .text-green-600 { background-color: #1e4a1e; border-color: #008000; color: #aaffaa; }

    </style>
</head>
<body class="bg-gray-900">
    <header class="app-header">
        <h1 class="text-4xl font-extrabold text-white">Code Canvas</h1>
        <p class="text-lg text-gray-400">Browser-based JavaScript IDE</p>
    </header>

    <div class="container">
        <!-- Editor Panel -->
        <div class="editor-panel">
            <textarea id="code-editor"></textarea>
            <div class="control-panel">
                <button id="run-button" class="action-button">Run Code</button>
                <input type="text" id="library-url" placeholder="Paste library URL (e.g., d3.min.js)" class="w-full">
                <button id="load-library-button" class="action-button library-button">Load Library</button>
                <div id="library-status"></div>
            </div>
        </div>

        <!-- Output Panel -->
        <div class="output-panel">
            <pre id="output"></pre>
        </div>
    </div>

    <!-- CodeMirror JS Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js"></script>
    <!-- CodeMirror Addons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/display/fullscreen.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/search/search.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/search/searchcursor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/search/matchesonscrollbar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/search/jump-to-line.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/dialog/dialog.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/javascript-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/lint/lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/lint/javascript-lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/keymap/sublime.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jshint/2.13.5/jshint.min.js"></script> <!-- Required for javascript-lint -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/fold/brace-fold.min.js"></script>


    <script>
        // Get references to DOM elements
        const codeEditorElement = document.getElementById('code-editor');
        const runButton = document.getElementById('run-button');
        const outputConsole = document.getElementById('output');
        const libraryUrlInput = document.getElementById('library-url');
        const loadLibraryButton = document.getElementById('load-library-button');
        const libraryStatus = document.getElementById('library-status');

        // Initialize CodeMirror editor
        const editor = CodeMirror.fromTextArea(codeEditorElement, {
            mode: 'javascript',
            theme: 'dracula',
            lineNumbers: true,
            indentUnit: 2,
            tabSize: 2,
            lineWrapping: true,
            autoCloseBrackets: true,
            matchBrackets: true,
            extraKeys: {
                "F11": function(cm) {
                    cm.setOption("fullScreen", !cm.getOption("fullScreen"));
                },
                "Esc": function(cm) {
                    if (cm.getOption("fullScreen")) cm.setOption("fullScreen", false);
                },
                "Ctrl-Space": "autocomplete",
                "Ctrl-Q": function(cm){
                    cm.foldCode(cm.getCursor());
                }
            },
            keyMap: "sublime",
            foldGutter: true,
            gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter", "CodeMirror-lint-markers"],
            lint: true,
            hintOptions: { hint: CodeMirror.hint.javascript, completeSingle: false },
            value: `// Welcome to the Code Canvas!
// This environment offers a VSCode-like experience directly in your browser.

// Editor Features:
// - VSCode-like Dark Theme (Dracula)
// - Line Numbers & Syntax Highlighting
// - Bracket Matching & Auto-closing
// - Autocompletion (Ctrl+Space or auto-trigger after typing a period for objects)
// - Linting (errors/warnings highlighted in the gutter)
// - Fullscreen Mode (F11)
// - Search & Replace (Ctrl+F)
// - Sublime Text Keymap (e.g., Ctrl+D to select next occurrence)

function calculateFactorial(n) {
  if (n === 0 || n === 1) {
    return 1;
  }
  return n * calculateFactorial(n - 1);
}

console.log('Factorial of 7:', calculateFactorial(7));

// To load an external library:
// 1. Paste its CDN URL in the input field below.
// 2. Click 'Load Library'.
// Example: Lodash (https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js)
// Then use it: console.log('Debounced function:', _.debounce(() => {}, 100));

// Example of an intentional linting warning:
var i = 0; // 'var' is often discouraged in modern JavaScript; consider 'const' or 'let'.
if (i == '0') { // Use '===' for strict equality to avoid type coercion issues.
    console.log('Loose equality check warning.');
}
`
        });

        // --- Code Execution Logic ---
        runButton.addEventListener('click', () => {
            const codeToExecute = editor.getValue();
            outputConsole.textContent = ''; // Clear previous output

            const originalConsoleLog = console.log;
            const originalConsoleError = console.error;

            console.log = (...args) => {
                outputConsole.textContent += args.map(arg => {
                    if (typeof arg === 'object' && arg !== null) {
                        try {
                            return JSON.stringify(arg, null, 2);
                        } catch (e) {
                            return String(arg);
                        }
                    }
                    return String(arg);
                }).join(' ') + '\n';
                originalConsoleLog(...args);
            };
            console.error = (...args) => {
                outputConsole.textContent += 'ERROR: ' + args.map(arg => {
                    if (typeof arg === 'object' && arg !== null) {
                        try {
                            return JSON.stringify(arg, null, 2);
                        } catch (e) {
                            return String(arg);
                        }
                    }
                    return String(arg);
                }).join(' ') + '\n';
                originalConsoleError(...args);
            };

            try {
                // Execute the code in a function wrapper
                const executableFunction = new Function(codeToExecute);
                executableFunction();
            } catch (error) {
                console.error('Execution Error:', error);
            } finally {
                setTimeout(() => {
                    console.log = originalConsoleLog;
                    console.error = originalConsoleError;
                }, 100);
            }
        });

        // --- Library Loading Logic ---
        loadLibraryButton.addEventListener('click', () => {
            const libraryUrl = libraryUrlInput.value.trim();
            if (!libraryUrl) {
                libraryStatus.textContent = 'Please enter a library URL.';
                libraryStatus.className = 'mt-3 text-sm text-red-600';
                return;
            }

            const existingScripts = document.querySelectorAll(`script[src="${libraryUrl}"]`);
            if (existingScripts.length > 0) {
                libraryStatus.textContent = 'Library already loaded.';
                libraryStatus.className = 'mt-3 text-sm text-yellow-600';
                return;
            }

            libraryStatus.textContent = 'Loading library...';
            libraryStatus.className = 'mt-3 text-sm text-blue-600';

            const script = document.createElement('script');
            script.src = libraryUrl;
            script.async = true;

            script.onload = () => {
                libraryStatus.textContent = `Library "${libraryUrl.split('/').pop()}" loaded successfully!`;
                libraryStatus.className = 'mt-3 text-sm text-green-600';
                libraryUrlInput.value = '';
            };

            script.onerror = (e) => {
                libraryStatus.textContent = `Failed to load library from "${libraryUrl}". Check the URL.`;
                libraryStatus.className = 'mt-3 text-sm text-red-600';
                console.error('Failed to load library:', libraryUrl, e);
            };

            document.head.appendChild(script);
        });

        // Add auto-completion trigger on dot for properties and general input
        editor.on("inputRead", function(cm, change) {
            // Trigger autocomplete on '.' or if the change is a single character input that's a word character or '$'
            if (change.text[0] === "." || (change.origin === "+input" && /[\w$]$/.test(change.text[0]))) {
                CodeMirror.commands.autocomplete(cm, null, { completeSingle: false });
            }
        });

        // Initial setup for CodeMirror to take full height
        // This is important because CodeMirror needs its container to have a defined height
        editor.setSize(null, '100%');
    </script>
</body>
</html>
